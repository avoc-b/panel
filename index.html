<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
  	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Panel</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
  	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.1/cropper.css">
  	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jodit/3.4.29/jodit.css" />
  	<link rel="stylesheet" href="css/colorPick.css" />
  	<style type="text/css">
  		.shoppanel-input textarea {
  			background-color: transparent;
			border: 0 none;
			box-shadow: 0 0 2px #17a2b8;
			padding: 0 5px;
			width: 100%;

			/* для принятия родительских стилей */
			font-size: unset;
			font-weight: unset;
			color: unset;
  		}
  		.shoppanel-box {
  			position: absolute;
  			top: -1000px;
  			left: 0;
  			background-color: #fff;
  			z-index: 10;
  		}
  		.shoppanel-load {
  			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			padding: 40px;
			background-color: rgba(250,250,250, 0.5);
			z-index: 1040;
  		}
  		.shoppanel-load > div {
  			margin:	10% auto;
  			padding: 40px;
  			background-color: rgba(23,162,184, 0.8);
  			color: #fff;
  			width: 400px;
			text-align: center;
			border-radius: 3px;
  		}
		.shoppanel-picker {
			border-radius: 5px;
			width: 24px;
			height: 24px;
			cursor: pointer;
			-webkit-transition: all linear .2s;
			-moz-transition: all linear .2s;
			-ms-transition: all linear .2s;
			-o-transition: all linear .2s;
			transition: all linear .2s;
			border: thin solid #eee;
			display: inline-block;
		}
		.shoppanel-picker:hover {
			transform: scale(1.1);
		}

  		[data-edit] {
  			white-space: break-spaces;
  		}


  		.img-logo {
  			max-width: 250px;
			max-height: 100px;
			margin-top: -10%;
  		}
  		.img-wrap {
		    max-width: 100%;
		    height: 300px;
		    border: 1px solid #ddd;
		    overflow: hidden;
		    position: relative;
		}		
	    .img-title {
			position: absolute;
			bottom: 25px;
			left: 32px;
			color: #333;
			font-size: 24px;
			width: 400px;
	    }
  	</style>  
</head>
<body>

	<!-- Панель магазина (начало) -->
	<div id="shoppanel">
		<nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-top">
			<a class="navbar-brand" href="#">Shop Panel</a>
			<ul class="navbar-nav mr-auto">
				<li class="navbar-text">ЦВЕТ: основной</li>
				<li class="navbar-text ml-2 mr-4">
				  <span class="shoppanel-picker" data-initialcolor="#26cae5" data-color="main"></span>
				</li>
				<li class="navbar-text">фоновый</li>
				<li class="navbar-text ml-2 mr-4">
				  <span class="shoppanel-picker" data-initialcolor="#ffffff" data-color="fon"></span>
				</li>
				<li class="navbar-text">при наведении</li>
				<li class="navbar-text ml-2 mr-4">
				  <span class="shoppanel-picker" data-initialcolor="#26cae5" data-color="hover"></span>
				</li>
			    <li class="nav-item dropdown">
			      <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
			        ШРИФТ
			      </a>
			      <div class="dropdown-menu">
			        <a href="#" class="dropdown-item" data-font="arial">Arial</a>
			        <a href="#" class="dropdown-item" data-font="Amatic+SC">Amatic SC</a>
			        <a href="#" class="dropdown-item" data-font="caveat">Caveat</a>
			        <a href="#" class="dropdown-item" data-font="inter">Inter</a>
			        <a href="#" class="dropdown-item" data-font="jura">Jura</a>
			        <a href="#" class="dropdown-item" data-font="montserrat">Montserrat</a>
			        <a href="#" class="dropdown-item" data-font="Open+Sans">Open Sans</a>
			        <a href="#" class="dropdown-item" data-font="oswald">Oswald</a>
			        <a href="#" class="dropdown-item" data-font="philosopher">Philosopher</a>
			        <a href="#" class="dropdown-item" data-font="raleway">Raleway</a>
			        <a href="#" class="dropdown-item" data-font="roboto">Roboto</a>
			        <a href="#" class="dropdown-item" data-font="rubik">Rubik</a>
			        <a href="#" class="dropdown-item" data-font="tahoma">Tahoma</a>
			        <a href="#" class="dropdown-item" data-font="verdana">Verdana</a>
			      </div>
			    </li>
			</ul>
		  	<div class="form-inline my-2 my-lg-0">
		  		<button type="button" class="btn btn-outline-info my-2 my-sm-0 mr-2">
		  			<i class="fa fa-user"></i> Кабинет
		  		</button>
				<button class="btn btn-info my-2 my-sm-0" type="button" data-save="on">Сохранить изменения</button>
		    </div>
		</nav>

		<div class="shoppanel-box">
			<div class="btn-group">
				<button type="button" class="btn btn-outline-info" data-format="bold">
					<i class="fa fa-bold"></i>
				</button>
				<div class="btn-group">
					<button type="button" class="btn btn-outline-info dropdown-toggle" data-toggle="dropdown">
						<i class="fa fa-text-height"></i>
					</button>
					<div class="dropdown-menu">
						<button class="dropdown-item" data-format="size" data-val="10">10</button>
						<button class="dropdown-item" data-format="size" data-val="12">12</button>
						<button class="dropdown-item" data-format="size" data-val="14">14</button>
						<button class="dropdown-item" data-format="size" data-val="16">16</button>
						<button class="dropdown-item" data-format="size" data-val="20">20</button>
						<button class="dropdown-item" data-format="size" data-val="24">24</button>
						<button class="dropdown-item" data-format="size" data-val="28">28</button>
						<button class="dropdown-item" data-format="size" data-val="32">32</button>
						<button class="dropdown-item" data-format="size" data-val="36">36</button>
						<button class="dropdown-item" data-format="size" data-val="40">40</button>
				    </div>
				</div>
				<div class="btn-group">
					<button type="button" class="btn btn-outline-info dropdown-toggle" data-toggle="dropdown">
						<i class="fa fa-tint"></i>
					</button>
					<div class="dropdown-menu">
						<button class="dropdown-item" data-format="color" data-val="#000">Чёрный</button>
						<button class="dropdown-item" data-format="color" data-val="#555">Серый</button>
						<button class="dropdown-item" data-format="color" data-val="#fff">Белый</button>
						<button class="dropdown-item" data-format="color" data-val="#900">Красный</button>
						<button class="dropdown-item" data-format="color" data-val="#090">Зелёный</button>
						<button class="dropdown-item" data-format="color" data-val="#009">Синий</button>
				    </div>
				</div>					
				<button type="button" class="btn btn-outline-info" data-upload="img">
					<i class="fa fa-upload"></i> Загрузить изображение
				</button>
			</div>

			<input type="file" id="file" name="file" accept="image/*" style="display: none;" />
		</div>


		<div class="shoppanel-load">
			<div>
				<h4>Подготовка к работе</h4>
				<button class="btn btn-info" disabled>
					<span class="spinner-border spinner-border-sm"></span>
					Подождите...
				</button>
			</div>
		</div>
	</div>
	<!-- Панель магазина (конец) -->



	<!-- Настраиваемые стили -->
	<style type="text/css" id="css-main">
		* {
			font-family: "Arial", sans-serif;
		}
		body { 
			background-color: #ffffff;
		}
		a {
			color: #26cae5;
		}
		a:hover {
			color: #ff5555;
		}
	</style>



	<header class="container" style="margin-top:80px">		
		<ul class="nav">
			<li class="navbar-brand">
				<a class="navbar-brand img-logo" href="/">
					<img src="img/logo.png" style="width: 100%;" data-edit="img" />
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="#" data-edit="txt" data-group="1">Link</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="#" data-edit="txt" data-group="1">Link</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="#" data-edit="txt" data-group="1">Link</a>
			</li>
			<li class="nav-item">
				<a class="nav-link disabled" href="#">Disabled</a>
			</li>
		</ul> 
	</header>
	<main class="container">
		<div class="jumbotron">
		  <h1 data-edit="txt" id="h">Bootstrap Tutorial</h1>
		  <p data-edit="txt">Bootstrap is the most popular HTML, CSS...</p>
		</div>

		<div class="img-wrap mb-3">
			<img src="img/picture.jpg" style="width: 100%;" data-edit="img" />
			<div class="img-title" data-edit="txt">Максимально мотивирующий текст</div>
		</div>

		<div class="media border p-3">
		  <img src="img/picture-2.jpg" alt="John Doe" class="mr-3 mt-3 rounded-circle" style="width:60px;">
		  <div class="media-body">
		    <h4>John Doe <small><i>Posted on February 19, 2016</i></small></h4>
		    <p>Lorem ipsum...</p>
		    <div class="media p-3">
		      <img src="img/picture-2.jpg" alt="Jane Doe" class="mr-3 mt-3 rounded-circle" style="width:45px;">
		      <div class="media-body">
		        <h4>Jane Doe <small><i>Posted on February 20 2016</i></small></h4>
		        <p>Lorem ipsum...</p>
		      </div>
		    </div> 
		  </div>
		</div>
	</main>
	<footer class="container">
		<p>© 2020, Все права защищены</p>
	</footer>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.1/cropper.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jodit/3.4.29/jodit.min.js"></script>
	<!--<script src="https://cdn.jsdelivr.net/npm/a-color-picker@1.2.1/dist/acolorpicker.min.js"></script>-->
	<script src="js/colorPick.js"></script>
	<script type="text/javascript">
		

		$(function(){

			var elBox = $('.shoppanel-box');
			var panel = {
				open: function(e){
					e.preventDefault();
					e.stopPropagation();

					var self = $(this)
						edit = self.data(),
						text = self.text(),
						rows = text.split('\n').length;						

					console.log('[open]', self, text, edit);

					// если открыто на редакцию, то ничего
					if(self.find('.shoppanel-input').length) return;

					// все др. редакторы закрыть
					panel.closeAll();

					if(edit.edit == 'txt') {
						self.text('');

						var textarea = $('<textarea>', {type: 'text', rows: rows/*, value: text*/})
							.appendTo(self)
							.wrap('<div class="shoppanel-input">')
							.focus()
							.val(text);

						// пересчёт высоты
						$.proxy(panel.resize, textarea.get(0))();

						// скрыть кнопку "загрузить фото"
						elBox.find('[data-upload]').hide()
							.end()
							.find('[data-format], .btn-group .btn-group').show();
					}

					if(edit.edit == 'img') {
						console.log('[open:img]', elBox.find('[data-upload]'));

						self.addClass('shoppanel-upload');

						// скрыть кнопки форматирования
						elBox.find('[data-upload]').show()
							.end()
							.find('[data-format], .btn-group .btn-group').hide();
					}
					
					var size = self.offset(),
						// видимая часть экрана:
						win = {
							top: $(window).scrollTop(),
							bottom: $(window).scrollTop() + $(window).height()
						};
					size.h = self.outerHeight();
					var top = size.top + size.h +5;

					if(win.bottom < top + elBox.outerHeight()) {
						top = size.top - elBox.outerHeight() -5;
					}
					//console.log('[open]', size.top, size.h, elBox.outerHeight());

					elBox.css({
						top: top,
						left: size.left
					});

					// подсветка кнопок
					var style = self.attr('style'),
						isset = 0;
					elBox.find('[data-format]').each(function(i, v){
						var btn  = $(v),
							data = btn.data();
						switch(data.format) {
							case 'bold'	: isset = /font-weight:/g.test(style) ? 1:0; break;
							case 'size'	: isset = /font-size:/g.test(style) ? 1:0; break;
							case 'color': isset = /color:/g.test(style) ? 1:0; break;
						}
						if(data.val) {
							btn = btn.parent().prev();
							btn.dropdown('hide');
						}
						if(isset) 
							 btn.addClass('btn-info').removeClass('btn-outline-info');
						else btn.addClass('btn-outline-info').removeClass('btn-info');						
					});
				},
				closeAll: function(){
					$('.shoppanel-input').each(function(i, v){

						var self = $(v),
							text = self.find('textarea').val();

						//console.log('[clear]', i, text);

						self.parent().text(text);
					});
					$('.shoppanel-upload').removeClass('shoppanel-upload');
				},
				format: function(e){

					var self = $(this),
						data = self.data(),
						elem = $('.shoppanel-input').parent(),
						edit = elem.data(),
						text = elem.find('textarea').val(),
						wrap = data.val ? self.parent().prev() : self,
						isset= wrap.is('.btn-outline-info'); // нажата или нет

					console.log('[format]', data, isset, wrap, elem);

					if(data.val) {
						wrap.addClass('btn-info').removeClass('btn-outline-info');
					}										
					else self.toggleClass('btn-outline-info btn-info');

					if(edit.group) {
						elem = $('[data-group="'+ edit.group +'"]');
					}

					switch(data.format) {
						case 'bold'	: elem.css('font-weight', isset ? 'bold' : ''); break;
						case 'size'	: elem.css('font-size', isset||data.val ? data.val : ''); break;
						case 'color': elem.css('color', isset||data.val ? data.val : ''); break;
					}
				},
				file: function(e) {
					elBox.find('input:file').trigger('click');

					//console.log('[upload]', elBox.find('input:file'));
				},
				upload: function(e) {
					var files = e.target.files,
						elem  = $('.shoppanel-upload');

					elem.attr('src', URL.createObjectURL(files[0]));

					//console.log('[file]', files[0]);
				},
				color: function() {							
					// цвета поумолчанию
					var css 	= $('#css-main').text(),
						clrMain = /a {\s+color: ([#\w]+);/g.exec(css),
						clrFon	= /body {\s+background-color: ([#\w]+);/g.exec(css),
						clrHover= /a:hover {\s+color: ([#\w]+);/g.exec(css);

					$('[data-color]').each(function(i, v){
						switch(v.dataset.color) {
							case 'main'	: v.dataset.initialcolor = clrMain[1]; break;
							case 'fon'	: v.dataset.initialcolor = clrFon[1]; break;
							case 'hover': v.dataset.initialcolor = clrHover[1]; break;
					    }
					});

					// выбор цвета
					$('.shoppanel-picker').colorPick({
						paletteLabel: 'Выберите цвет',
						allowCustomColor: true,
						// initialColor: '#27ae60',
						// palette: ["#1abc9c", "#16a085", "#2ecc71"],
						// allowRecent: false,
						onColorShown: function() {
							//console.log('[color:onColorOpened]', this);

							// закрыть др. всплывающие окна в главном меню
							$('#shoppanel .dropdown-toggle').dropdown('hide');
						},
						onColorSelected: function() {
							var type = this.element.data('color'),
								elem = $('#css-main'),
								css  = elem.text();

						    this.element.css({
						    	backgroundColor: this.color, 
						    	color: this.color
						    });

						    switch(type) {
						    	case 'main'	: css = css.replace(/(a {\s+color: )([#\w]+);/g, '$1'+ this.color +';'); break;
						    	case 'fon'	: css = css.replace(/(body {\s+background-color: )([#\w]+);/g, '$1'+ this.color +';'); break;
						    	case 'hover': css = css.replace(/(a:hover {\s+color: )([#\w]+);/g, '$1'+ this.color +';'); break;
						    }
						    
							elem.html(css);
						    //console.log('[colorPick]', this, this.color, type, css);						    
						},
					});
				},
				font: function(e) {
					e.preventDefault();

					var font = this.dataset.font, //.toLowerCase(),
						elem = $('#css-main'),
						css  = elem.text();

            		font = font.replace(font[0], font[0].toUpperCase());
					css  = css.replace(/(\* {\s+font-family: )"([#\s\w]+)", sans-serif;/g, '$1"'+ font.replace('+', ' ') +'", sans-serif;');
					css  = css.replace(/@import url(.*);/g, '');
					css  = css.replace(/^\s+$/m, '');

					if(['Arial','Tahoma','Verdana'].indexOf(font) == -1) {
						css  = "\n\t\t@import url('https://fonts.googleapis.com/css2?family="+ font +":wght@400;700&display=swap');" + css;
					}
					
					elem.html(css);
					$(this).addClass('active').siblings().removeClass('active');
					console.log('[font]', font, css);	
				},
				resize: function(e) {

					// var el = $('<span>');
					// el.html(
					// 	$(this).val().replace(/ /g,'&nbsp;')
					// ).insertAfter($(this));
					// $(this).width(el.width() +1);
					// el.remove();

					$(this)
						.attr('rows', 1)
						.height('auto')
						.height(this.scrollHeight +'px');
				},
				loader: function(msg) {
					// закрытие заставки
					if(false === msg) return $('.shoppanel-load').fadeOut(400);

					$('.shoppanel-load')
						.fadeIn(300)
						.find('h4').html(msg);
				},
				save: function() {
					panel.loader('Идёт сохранение');
					setTimeout(e => {
						panel.loader('Успешно сохранено!');
						setTimeout(e => {
							panel.loader(false);
						}, 2000);
					}, 5000);
				},
			};

			$(document)
				.on('click', '[data-edit]', panel.open)
				.on('click', '[data-format]', panel.format)
				.on('click', '[data-upload]', panel.file)
				.on('click', '[data-font]', panel.font)
				.on('change', elBox.find('input:file'), panel.upload)
				.on('keyup change drop paste focusin focusout', '[data-edit] textarea', panel.resize)
				.on('click', '[data-save]', panel.save);


			console.clear();

			// закрытие заставки
			panel.loader(false);

			// первый элемент на редакцию
			$('[data-edit]').not('[data-group]').first().trigger('click');

			// глобальный цвет
			panel.color();

		});
	</script>
</body>
</html>